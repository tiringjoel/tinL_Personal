%-------------------------
%clang
%(c) H.Buchmann FHNW 2008
%export TEXINPUTS=.:${HOME}/fhnw/edu/:${HOME}/fhnw/edu/tinL/config/latex:${HOME}/fhnw/edu/config//:
%-------------------------
\documentclass{beamer}
\usepackage{beamer}
\input{defines.tex}
\input{/home/buchmann/latex/dirtree/dirtree.tex}

\usepackage[absolute]{textpos}
\setlength{\TPHorizModule}{1mm}
\setlength{\TPVertModule}{1mm}

\begin{document}

\title[Build]{Ein ganzes \linux}

\frame{\titlepage}

\begin{frame}{Um was geht es ?}
 \begin{itemize}
  \item ein \linux von Grund auf bauen
  \begin{itemize}
   \item nicht mehr so schwer wie auch schon
  \end{itemize}
  \item nicht völlig automatisiert
  \item Alternative zu {\bf yocto} \& Co.
 \end{itemize}
\end{frame}

\begin{frame}{Ziel}{\linux auf dem \target}
\begin{itemize}
 \item command based
 \item Ethernet
 \item \cod{ssh} 
 \item \cod{sshfs}
 \item moderne Toolchain inkl. {\em c++11} \cpp 
\end{itemize}
\end{frame}

\section{Die Komponenten}
\begin{frame}{Komponenten}{\target und \host}
 \begin{block}{\target}
  \begin{description}
   \item[Kernel] ein File
   \item[root] ein Filesystem
  \end{description}
 \end{block}
 \begin{block}{\host}
  \begin{description}
   \item[Toolchain] binutils, gcc
  \end{description}
 \end{block}
\end{frame}
\subsection{Target \target}

\begin{frame}{Übersicht}
 \begin{center}
  \includegraphics[width=8cm]{layers.pdf}
 \end{center}
\end{frame}

\begin{frame}{Die Komponenten}{für \target}
 \begin{description}
  \item[Hardware] \target
  \item[Kernel] zugeschnitten auf \target
  \begin{itemize}
    \item {\tiny \url{github.com/beagleboard/linux}}
  \end{itemize}	
  \item[root] das Filesystem
  \begin{description}
   \item[LibC] glibc 
   \begin{itemize}
    \item {\tiny \url{www.gnu.org/software/libc/index.html}}
   \end{itemize}	
   \item[\unix] busybox
   \begin{itemize}
    \item {\tiny \url{www.busybox.net/}}
   \end{itemize}
   \item[...] Weitere \unix basierte Komponenten
   \begin{itemize}
    \item das \cod{configure}, \cod{make}, \cod{make install} Triple 
   \end{itemize}
   \end{description}
 \end{description}
\end{frame}

\subsection{\host}
\begin{frame}{Toolchain}
 \begin{description}
  \item[binutils] linker \& Co.
  \item[gcc] compiler
  \begin{itemize}
   \item \cod{libgcc} die Bibliothek für den Compiler
  \end{itemize}
 \end{description}
 
 \begin{remarks}
 \item die Toolchain muss zweimal gebaut werden
 \begin{itemize}
  \item für den \kernel und \cod{libc} 
  \item für \unix/\posix
 \end{itemize}
 \item das target
 \begin{itemize} 
  \item \cod{cpu-vendor-os}
  
 \end{itemize}
 \end{remarks}
\end{frame}

\begin{frame}{Die Verzeichnisstruktur}
\dirtree{%
 .1 .
 .2 tools.
 .3 common.h \DTcomment{used in (all) scripts}.
 .2 config.
 .3 Makefile.
 .2 build \DTcomment{home of the build files}.
 .2 target-root \DTcomment{top of targer root}.
 .2 tc \DTcomment{the new toolchain}.
 .2 src \DTcomment{own programs}.
 .2 work.
 .3 $\to$ {../config/Makefile}.
}
\end{frame}

\section{Build}
\subsection{Initiales \linux}
\begin{frame}{Build 1}{Toolchain 1}
 \begin{itemize}
  \item \cod{binutils}
  \item \cod{gcc-bare} 
  \begin{itemize}
   \item nur für den {\em kernel}
   \item das bare minimum
   \item nur {\Large C}
  \end{itemize}
 \end{itemize}
\end{frame}

\begin{frame}{Build 2}{Kernel}
 \begin{itemize} 
  \item \cod{kernel} mit ein paar {\em targets}
   \begin{itemize}
    \item \cod{bb.org\_defconfig}
    \item \cod{zImage}
    \item \cod{headers\_install} 
	\begin{itemize}
	 \item Interface: {\em kernel}-{\em libc}
	\end{itemize}
   \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}{Build 3}{libc}{Wir brauchen eglibc}
 \begin{itemize} 
  \item \cod{eglibc} 
 \end{itemize}
\end{frame}

\begin{frame}{Build 4}{Toolchain 2}
 \begin{itemize} 
  \item \cod{gcc} 
  \begin{itemize}
   \item mit \cod{sysroot}
   \item {\Large C} und {\Large C++}
  \end{itemize}
  \item Test
  \begin{itemize}\item im Verzeichnis \cod{work}\end{itemize}
 \end{itemize}
\end{frame}

\begin{frame}{Build 5}{busybox}
 \begin{itemize}
  \item \cod{busybox}
  \begin{itemize}
   \item Installation auf SD-Card
   \item \cod{fakeroot}
  \end{itemize}
 \end{itemize}
\end{frame}


\begin{frame}{Skripts und Argumente}{initiales System}
 \begin{tabular}{l|l|l}
  Skript & target & gebraucht für\\
  \hline\hline
  \cod{binutils.sh}& &alles\\
  \hline
  \cod{gcc-bare.sh}& &kernel libc\\
  \hline
  \cod{kernel.sh}  & \cod{defconfig}\\
                   & \cod{zImage}\\
                   & \cod{headers\_install}\\
  \hline
  \cod{glibc.sh}  & &POSIX\\
  \hline
  \cod{gcc.sh}     & &C/C++ POSIX\\
  \hline
  \cod{busybox.sh} & \cod{busybox}\\
  		   &\cod{install}\\
  \hline
  \cod{target-root.sh}&&Transfer auf SD-Card
 \end{tabular}
 \remark{Alle Skripte sind {\Large\tt bash} Skripte}
\end{frame}

\begin{frame}{Target}{erster Versuch}
\begin{itemize}
 \item transfer auf SD Karte
 \item Internet
\end{itemize}
\end{frame}

\begin{frame}{Skripts und Argumente}{ssh}
\begin{tabular}{lll}
 \cod{zlib.sh}\\
 \cod{openssl.sh}&&die kryptographischen Algorithmen\\
 \cod{openssh.sh}
\end{tabular}
\remark{\cod{openssh.sh} hängt von \cod{zlib.sh} und \cod{openssl.sh}
  ab}
\end{frame}

\subsection{ssh}
\begin{frame}{\cod{ssh}}
 \begin{itemize}
  \item \cod{openssh} die volle Implementation 
  \begin{itemize}
   \item \cod{zlib}
   \item \cod{openssl}
   \item \cod{openssh}
  \end{itemize}
%  \item \cod{sshfs}
 \end{itemize}
\end{frame}

\subsection{Workflow}
\begin{frame}{Workflow}{Begriffe}
\begin{description}[target-root]
 \item[target-root] Verzeichnis auf dem \host
 \begin{itemize}
  \item enthält das \target Rootfilesystem
  \item soll aktuell sein
 \end{itemize}
 \item[SD-Card] Speicherkarte mit dem \target Rootfilesystem
 \begin{itemize}
  \item entspricht  \cod{target-root}
 \end{itemize}
\end{description}
\end{frame}

\begin{frame}{target-root - SD-Card}{\cod{tar} \cod{rsync}}

\begin{tabular}{lcccc}
	&target-root&&SD-Card\\
\hline	
initiales \linux &$\to$& \cod{tar}   &$\to$\\
SD-Card          &$\leftarrow$& \cod{rsync} &$\leftarrow$\\  
target-root      &$\to$& \cod{rsync} &$\to$
\end{tabular}
\end{frame}

%\begin{frame}{Target}{ssh}
%\begin{itemize}
% \item \cod{ssh}
% \item \cod{sshd}
% \item Keys
%\end{itemize}
%\end{frame}

\begin{frame}{sshfs}{funktioniert noch nicht}
 \begin{itemize}
  \item Die Bibliothek \cod{glib}
  \item Ersatz
  \begin{itemize}
   \item \cod{sftp}
  \end{itemize}
 \end{itemize}
\end{frame}

\section{Modules}
\begin{frame}{Modules}
\begin{itemize}
 \item siehe \cod{6-modules}
\end{itemize}
\end{frame}

\begin{frame}{Modules}{Verzeichnisstruktur}
\begin{block}{Host}
\dirtree{%
 .1 BUILD\_HOME.
 .2 modules.
 .3 Makefile \DTcomment{for own modules}.
 .3 *.{c/h} \DTcomment{the own sources}.
 .2 scripts.
 .3 module.sh.
}
\end{block}
\begin{block}{\target}
\dirtree{%
.1 /.
.2 work.
}
\end{block}
\end{frame}
\begin{frame}{Herstellung}{Workflow}
 \begin{block}{Host}
 \begin{itemize}
  \item \cod{sh scripts/module.sh {\em module}}
  \item \cod{scp}, \cod{sftp}, \cod{ftp}
 \end{itemize}
 \end{block}
 \begin{block}{\target}
  \begin{itemize}
   \item \cod{insmod}
   \item \cod{rmmod}
  \end{itemize}
 \end{block}
\end{frame}

%\input{tft-display.tex}
\end{document}
